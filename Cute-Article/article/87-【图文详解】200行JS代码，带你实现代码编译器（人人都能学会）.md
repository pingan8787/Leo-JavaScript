![011ead2e167b86d1d4def84147fbbdf6c6bb1c01.jpg](https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585365502950-d474962e-f17c-4aec-bcf4-1252dd5f0e5d.jpeg#align=left&display=inline&height=720&name=011ead2e167b86d1d4def84147fbbdf6c6bb1c01.jpg&originHeight=720&originWidth=1280&size=507947&status=done&style=none&width=1280)<br />

> æœ€è¿‘çœ‹åˆ°æ˜é‡‘ã€å‰ç«¯å…¬ä¼—å·å¥½å¤š ES2020 çš„æ–‡ç« ï¼Œæƒ³è¯´ä¸€å¥ï¼šæ”¾å¼€æˆ‘ï¼Œæˆ‘è¿˜å­¦å¾—åŠ¨ï¼


<br />å…ˆé—®å¤§å®¶ä¸€å¥ï¼Œæ—¥å¸¸é¡¹ç›®å¼€å‘ä¸­ä½ èƒ½ç¦»å¼€ ES6 å—ï¼Ÿ<br />

# ä¸€ã€å‰è¨€
å¯¹äºå‰ç«¯åŒå­¦æ¥è¯´ï¼Œç¼–è¯‘å™¨å¯èƒ½é€‚åˆç¥å¥‡çš„é­”ç›’ğŸï¼Œè¡¨é¢æ™®é€šï¼Œä½†å¸¸å¸¸ç»™æˆ‘ä»¬æƒŠå–œã€‚<br />ç¼–è¯‘å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨æ¥ç¼–è¯‘ï¼Œç¼–è¯‘ä»€ä¹ˆå‘¢ï¼Ÿå½“ç„¶æ˜¯ç¼–è¯‘ä»£ç å’¯ğŸŒ¹ã€‚<br />
![](https://st-gdx.dancf.com/gaodingx/0/design/20191125-144728-7a47.gif)
<br />å…¶å®æˆ‘ä»¬ä¹Ÿç»å¸¸æ¥è§¦åˆ°ç¼–è¯‘å™¨çš„ä½¿ç”¨åœºæ™¯ï¼š

- React ä¸­ JSX è½¬æ¢æˆ JS ä»£ç ï¼›
- é€šè¿‡ Babel å°† ES6 åŠä»¥ä¸Šè§„èŒƒçš„ä»£ç è½¬æ¢æˆ ES5 ä»£ç ï¼›
- é€šè¿‡å„ç§ Loader å°† Less / Scss ä»£ç è½¬æ¢æˆæµè§ˆå™¨æ”¯æŒçš„ CSS ä»£ç ï¼›
- å°† TypeScript è½¬æ¢ä¸º JavaScript ä»£ç ã€‚
- and so on...


<br />ä½¿ç”¨åœºæ™¯éå¸¸ä¹‹å¤šï¼Œæˆ‘çš„åŒæ‰‹éƒ½æ•°ä¸è¿‡æ¥äº†ã€‚ğŸ˜„<br />è™½ç„¶ç°åœ¨ç¤¾åŒºå·²ç»æœ‰éå¸¸å¤šå·¥å…·èƒ½ä¸ºæˆ‘ä»¬å®Œæˆä¸Šè¿°å·¥ä½œï¼Œä½†äº†è§£ä¸€äº›ç¼–è¯‘åŸç†æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚æ¥ä¸‹æ¥è¿›å…¥æœ¬æ–‡ä¸»é¢˜ï¼š**200è¡ŒJSä»£ç ï¼Œå¸¦ä½ å®ç°ä»£ç ç¼–è¯‘å™¨**ã€‚<br />

# äºŒã€ç¼–è¯‘å™¨ä»‹ç»


## 2.1 ç¨‹åºè¿è¡Œæ–¹å¼
ç°ä»£ç¨‹åºä¸»è¦æœ‰ä¸¤ç§ç¼–è¯‘æ¨¡å¼ï¼šé™æ€ç¼–è¯‘å’ŒåŠ¨æ€è§£é‡Šã€‚æ¨èä¸€ç¯‡æ–‡ç« [ã€ŠAngular 2 JIT vs AOTã€‹](https://segmentfault.com/a/1190000008739157)ä»‹ç»å¾—éå¸¸è¯¦ç»†ã€‚<br />

### é™æ€ç¼–è¯‘
ç®€ç§° **AOT**ï¼ˆAhead-Of-Timeï¼‰å³ **æå‰ç¼–è¯‘** ï¼Œé™æ€ç¼–è¯‘çš„ç¨‹åºä¼šåœ¨æ‰§è¡Œå‰ï¼Œä¼šä½¿ç”¨æŒ‡å®šç¼–è¯‘å™¨ï¼Œå°†å…¨éƒ¨ä»£ç ç¼–è¯‘æˆæœºå™¨ç ã€‚<br />![](https://cdn.nlark.com/yuque/0/2020/png/186051/1585444832720-63703404-8cc9-45da-b38b-c8c482474d89.png#align=left&display=inline&height=252&originHeight=252&originWidth=800&size=0&status=done&style=none&width=800)<br />ï¼ˆå›¾ç‰‡æ¥è‡ªï¼š[https://segmentfault.com/a/1190000008739157](https://segmentfault.com/a/1190000008739157)ï¼‰<br />
<br />åœ¨ Angular çš„ AOT ç¼–è¯‘æ¨¡å¼å¼€å‘æµç¨‹å¦‚ä¸‹ï¼š

- ä½¿ç”¨ TypeScript å¼€å‘ Angular åº”ç”¨
- è¿è¡Œ ngc ç¼–è¯‘åº”ç”¨ç¨‹åº
  - ä½¿ç”¨ Angular Compiler ç¼–è¯‘æ¨¡æ¿ï¼Œä¸€èˆ¬è¾“å‡º TypeScript ä»£ç 
  - è¿è¡Œ tsc ç¼–è¯‘ TypeScript ä»£ç 
- ä½¿ç”¨ Webpack æˆ– Gulp ç­‰å…¶ä»–å·¥å…·æ„å»ºé¡¹ç›®ï¼Œå¦‚ä»£ç å‹ç¼©ã€åˆå¹¶ç­‰
- éƒ¨ç½²åº”ç”¨


### åŠ¨æ€è§£é‡Š
ç®€ç§° **JIT**ï¼ˆJust-In-Timeï¼‰å³ **å³æ—¶ç¼–è¯‘** ï¼ŒåŠ¨æ€è§£é‡Šçš„ç¨‹åºä¼šä½¿ç”¨æŒ‡å®šè§£é‡Šå™¨ï¼Œä¸€è¾¹ç¼–è¯‘ä¸€è¾¹æ‰§è¡Œç¨‹åºã€‚<br />![](https://cdn.nlark.com/yuque/0/2020/png/186051/1585444890967-350485fc-9290-4aa9-b214-ca836ee5f827.png#align=left&display=inline&height=258&originHeight=258&originWidth=800&size=0&status=done&style=none&width=800)ï¼ˆå›¾ç‰‡æ¥è‡ªï¼š[https://segmentfault.com/a/1190000008739157](https://segmentfault.com/a/1190000008739157 "https://segmentfault.com/a/1190000008739157")ï¼‰<br />
<br />åœ¨ Angular çš„ JIT ç¼–è¯‘æ¨¡å¼å¼€å‘æµç¨‹å¦‚ä¸‹ï¼š

- ä½¿ç”¨ TypeScript å¼€å‘ Angular åº”ç”¨
- è¿è¡Œ tsc ç¼–è¯‘ TypeScript ä»£ç 
- ä½¿ç”¨ Webpack æˆ– Gulp ç­‰å…¶ä»–å·¥å…·æ„å»ºé¡¹ç›®ï¼Œå¦‚ä»£ç å‹ç¼©ã€åˆå¹¶ç­‰
- éƒ¨ç½²åº”ç”¨


### AOT vs JIT
**AOT ç¼–è¯‘æµç¨‹ï¼š**![](https://cdn.nlark.com/yuque/0/2020/png/186051/1585445214534-0af092ac-61bb-4702-bbb6-162d45c11b25.png#align=left&display=inline&height=582&originHeight=582&originWidth=800&size=0&status=done&style=none&width=800)ï¼ˆå›¾ç‰‡æ¥è‡ªï¼š[https://segmentfault.com/a/1190000008739157](https://segmentfault.com/a/1190000008739157)ï¼‰

**JIT ç¼–è¯‘æµç¨‹ï¼š**![](https://cdn.nlark.com/yuque/0/2020/png/186051/1585445244655-9acb42fd-5164-46ed-be93-1ca8fdb5dec5.png#align=left&display=inline&height=580&originHeight=580&originWidth=800&size=0&status=done&style=none&width=800)ï¼ˆå›¾ç‰‡æ¥è‡ªï¼š[https://segmentfault.com/a/1190000008739157](https://segmentfault.com/a/1190000008739157)ï¼‰

| ç‰¹æ€§ | AOT | JIT |
| :---: | :---: | :---: |
| ç¼–è¯‘å¹³å° | (Server) æœåŠ¡å™¨ | (Browser) æµè§ˆå™¨ |
| ç¼–è¯‘æ—¶æœº | Build (æ„å»ºé˜¶æ®µ) | Runtime (è¿è¡Œæ—¶) |
| åŒ…å¤§å° | è¾ƒå° | è¾ƒå¤§ |
| æ‰§è¡Œæ€§èƒ½ | æ›´å¥½ | - |
| å¯åŠ¨æ—¶é—´ | æ›´çŸ­ | - |



é™¤æ­¤ä¹‹å¤– AOT è¿˜æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬ä¸éœ€è¦å¯¼å…¥ä½“ç§¯åºå¤§çš„ angular ç¼–è¯‘å™¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æˆ‘ä»¬ JS è„šæœ¬åº“çš„å¤§å°
- ä½¿ç”¨ AOT ç¼–è¯‘åçš„åº”ç”¨ï¼Œä¸å†åŒ…å«ä»»ä½• HTML ç‰‡æ®µï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç¼–è¯‘ç”Ÿæˆçš„ TypeScript ä»£ç ï¼Œè¿™æ ·çš„è¯ TypeScript ç¼–è¯‘å™¨å°±èƒ½æå‰å‘ç°é”™è¯¯ã€‚æ€»è€Œè¨€ä¹‹ï¼Œé‡‡ç”¨ AOT ç¼–è¯‘æ¨¡å¼ï¼Œæˆ‘ä»¬çš„æ¨¡æ¿æ˜¯ç±»å‹å®‰å…¨çš„ã€‚


## 2.2 ç°ä»£ç¼–è¯‘å™¨å·¥ä½œæµç¨‹
æ‘˜æŠ„ç»´åŸºç™¾ç§‘ä¸­å¯¹ [ç¼–è¯‘å™¨](https://zh.wikipedia.org/wiki/%E7%B7%A8%E8%AD%AF%E5%99%A8?wprov=srpw1_0 "ç¼–è¯‘å™¨")å·¥ä½œæµç¨‹ä»‹ç»ï¼š
> ä¸€ä¸ªç°ä»£ç¼–è¯‘å™¨çš„ä¸»è¦å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
> æºä»£ç ï¼ˆsource codeï¼‰â†’ é¢„å¤„ç†å™¨ï¼ˆpreprocessorï¼‰â†’ ç¼–è¯‘å™¨ï¼ˆcompilerï¼‰â†’ æ±‡ç¼–ç¨‹åºï¼ˆassemblerï¼‰â†’ ç›®æ ‡ä»£ç ï¼ˆobject codeï¼‰â†’ é“¾æ¥å™¨ï¼ˆlinkerï¼‰â†’ å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆexecutablesï¼‰ï¼Œæœ€åæ‰“åŒ…å¥½çš„æ–‡ä»¶å°±å¯ä»¥ç»™ç”µè„‘å»åˆ¤è¯»è¿è¡Œäº†ã€‚

![](https://cdn.nlark.com/yuque/0/2020/png/186051/1585456824842-dec3c622-50d6-4a1d-928d-dcf05bbff06f.png#align=left&display=inline&height=758&name=image.png&originHeight=758&originWidth=974&size=413309&status=done&style=none&width=974)


è¿™é‡Œæ›´å¼ºè°ƒäº†ç¼–è¯‘å™¨çš„ä½œç”¨ï¼š**å°†åŸå§‹ç¨‹åºä½œä¸ºè¾“å…¥ï¼Œç¿»è¯‘äº§ç”Ÿç›®æ ‡è¯­è¨€çš„ç­‰ä»·ç¨‹åº**ã€‚

![The Super Tiny Compilerç¼–è¯‘å™¨å·¥ä½œæµç¨‹.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454325263-f01d7c93-e31c-404d-a3be-570f4d744a8e.png#align=left&display=inline&height=2000&name=The%20Super%20Tiny%20Compiler%E7%BC%96%E8%AF%91%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png&originHeight=2000&originWidth=4061&size=447252&status=done&style=none&width=4061)

![ç¼–è¯‘å™¨ä¸‰ä¸ªæ ¸å¿ƒé˜¶æ®µ.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454361140-a1405daf-1e23-401c-854c-4845478d1c1c.png#align=left&display=inline&height=2016&name=%E7%BC%96%E8%AF%91%E5%99%A8%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5.png&originHeight=2016&originWidth=3214&size=303164&status=done&style=none&width=3214)

ç›®å‰ç»å¤§å¤šæ•°ç°ä»£ç¼–è¯‘å™¨å·¥ä½œæµç¨‹åŸºæœ¬ç±»ä¼¼ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ ¸å¿ƒé˜¶æ®µï¼š

1. **è§£æï¼ˆ_Parsing_ï¼‰** ï¼šé€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æï¼Œå°†åŸå§‹ä»£ç å­—ç¬¦ä¸²è§£ææˆ**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰**ï¼›
1. **è½¬æ¢ï¼ˆ_Transformation_ï¼‰**ï¼šå¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œè½¬æ¢å¤„ç†æ“ä½œï¼›
1. **ç”Ÿæˆä»£ç ï¼ˆ_Code Generation_ï¼‰**ï¼šå°†è½¬æ¢ä¹‹åçš„ AST å¯¹è±¡ç”Ÿæˆç›®æ ‡è¯­è¨€ä»£ç å­—ç¬¦ä¸²ã€‚


# ä¸‰ã€ç¼–è¯‘å™¨å®ç°
æœ¬æ–‡å°†é€šè¿‡ **[The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/ "The Super Tiny Compiler")** æºç è§£è¯»ï¼Œå­¦ä¹ å¦‚ä½•å®ç°ä¸€ä¸ªè½»é‡ç¼–è¯‘å™¨ï¼Œæœ€ç»ˆ**å®ç°å°†ä¸‹é¢åŸå§‹ä»£ç å­—ç¬¦ä¸²ï¼ˆLisp é£æ ¼çš„å‡½æ•°è°ƒç”¨ï¼‰ç¼–è¯‘æˆ JavaScript å¯æ‰§è¡Œçš„ä»£ç **ã€‚<br />


|  | Lisp é£æ ¼ï¼ˆç¼–è¯‘å‰ï¼‰ | JavaScript é£æ ¼ï¼ˆç¼–è¯‘åï¼‰ |
| :--- | :--- | :--- |
| 2 + 2 | (add 2 2) | add(2, 2) |
| 4 - 2 | (subtract 4 2) | subtract(4, 2) |
| 2 + (4 - 2) | (add 2 (subtract 4 2)) | add(2, subtract(4, 2)) |


<br />è¯è¯´ [The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/) å·ç§°**å¯èƒ½æ˜¯æœ‰å²ä»¥æ¥æœ€å°çš„ç¼–è¯‘å™¨**ï¼Œå¹¶ä¸”å…¶ä½œè€… James Kyle ä¹Ÿæ˜¯ Babel æ´»è·ƒç»´æŠ¤è€…ä¹‹ä¸€ã€‚<br />![](https://st-gdx.dancf.com/gaodingx/46/design/20191206-135932-505a.gif)
<br />è®©æˆ‘ä»¬å¼€å§‹å§~<br />


## 3.1 The Super Tiny Compiler å·¥ä½œæµç¨‹
ç°åœ¨å¯¹ç…§å‰é¢ç¼–è¯‘å™¨çš„ä¸‰ä¸ªæ ¸å¿ƒé˜¶æ®µï¼Œäº†è§£ä¸‹ [The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/) Â ç¼–è¯‘å™¨æ ¸å¿ƒå·¥ä½œæµç¨‹ï¼š<br />![The Super Tiny Compilerç¼–è¯‘å™¨å·¥ä½œæµç¨‹.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454325263-f01d7c93-e31c-404d-a3be-570f4d744a8e.png#align=left&display=inline&height=2000&name=The%20Super%20Tiny%20Compiler%E7%BC%96%E8%AF%91%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png&originHeight=2000&originWidth=4061&size=447252&status=done&style=none&width=4061)<br />

**å›¾ä¸­è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š**

1. æ‰§è¡Œ**å…¥å£å‡½æ•°**ï¼Œè¾“å…¥**åŸå§‹ä»£ç å­—ç¬¦ä¸²**ä½œä¸ºå‚æ•°ï¼›

```javascript
// åŸå§‹ä»£ç å­—ç¬¦ä¸²
(add 2 (subtract 4 2))
```

2. è¿›å…¥**è§£æé˜¶æ®µï¼ˆParsingï¼‰**ï¼ŒåŸå§‹ä»£ç å­—ç¬¦ä¸²é€šè¿‡**è¯æ³•åˆ†æå™¨ï¼ˆTokenizerï¼‰**è½¬æ¢ä¸º**è¯æ³•å•å…ƒæ•°ç»„ï¼Œ**ç„¶åå†é€šè¿‡ **è¯æ³•åˆ†æå™¨ï¼ˆParserï¼‰**å°†**è¯æ³•å•å…ƒæ•°ç»„**è½¬æ¢ä¸º**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Tree ç®€ç§° ASTï¼‰**ï¼Œå¹¶è¿”å›ï¼›

![è§£æé˜¶æ®µ - è¯æ³•åˆ†æ.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454379570-ce69ec87-3e07-4cb3-a06e-1ea820dbeabf.png#align=left&display=inline&height=2055&name=%E8%A7%A3%E6%9E%90%E9%98%B6%E6%AE%B5%20-%20%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90.png&originHeight=2055&originWidth=2904&size=276157&status=done&style=none&width=2904)<br />![è§£æé˜¶æ®µ - è¯­æ³•åˆ†æ.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454387197-42b4310a-5838-48f6-b489-d1423034aeb3.png#align=left&display=inline&height=2055&name=%E8%A7%A3%E6%9E%90%E9%98%B6%E6%AE%B5%20-%20%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90.png&originHeight=2055&originWidth=2920&size=387663&status=done&style=none&width=2920)<br />

3. è¿›å…¥**è½¬æ¢é˜¶æ®µï¼ˆTransformationï¼‰**ï¼Œå°†ä¸Šä¸€æ­¥ç”Ÿæˆçš„ **AST å¯¹è±¡** å¯¼å…¥**è½¬æ¢å™¨ï¼ˆTransformerï¼‰**ï¼Œé€šè¿‡**è½¬æ¢å™¨**ä¸­çš„**éå†å™¨ï¼ˆTraverserï¼‰**ï¼Œå°†ä»£ç è½¬æ¢ä¸ºæˆ‘ä»¬æ‰€éœ€çš„**æ–°çš„ AST å¯¹è±¡**ï¼›

![è½¬æ¢é˜¶æ®µ.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454400903-c9d39b97-ea9f-48b2-b6f9-36c9d7918746.png#align=left&display=inline&height=2047&name=%E8%BD%AC%E6%8D%A2%E9%98%B6%E6%AE%B5.png&originHeight=2047&originWidth=2919&size=435282&status=done&style=none&width=2919)<br />

4. è¿›å…¥**ä»£ç ç”Ÿæˆé˜¶æ®µï¼ˆCode Generationï¼‰**ï¼Œå°†ä¸Šä¸€æ­¥è¿”å›çš„**æ–° AST å¯¹è±¡**é€šè¿‡**ä»£ç ç”Ÿæˆå™¨ï¼ˆCodeGeneratorï¼‰**ï¼Œè½¬æ¢æˆÂ **JavaScript Code**ï¼›

![ä»£ç ç”Ÿæˆé˜¶æ®µ.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454409636-8958cb36-898a-4aba-ad6c-551d8fb8f4d3.png#align=left&display=inline&height=2063&name=%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E9%98%B6%E6%AE%B5.png&originHeight=2063&originWidth=2936&size=342032&status=done&style=none&width=2936)<br />

5. **ä»£ç ç¼–è¯‘ç»“æŸ**ï¼Œè¿”å› **JavaScript Code**ã€‚


![](https://st-gdx.dancf.com/gaodingx/0/uxms/design/20200320-163503-12b5.gif)<br />
<br />ä¸Šè¿°æµç¨‹çœ‹å®Œåå¯èƒ½ä¸€è„¸æ‡µé€¼ï¼Œä¸è¿‡æ²¡äº‹ï¼Œè¯·ä¿æŒå¤´è„‘æ¸…é†’ï¼Œå…ˆæœ‰ä¸ªæ•´ä¸ªæµç¨‹çš„å°è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹é˜…è¯»ä»£ç ï¼š<br />

## 3.2 å…¥å£æ–¹æ³•
é¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¥å£æ–¹æ³• `compiler` ï¼Œæ¥æ”¶åŸå§‹ä»£ç å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œè¿”å›æœ€ç»ˆ JavaScript Codeï¼š<br />

```javascript
// ç¼–è¯‘å™¨å…¥å£æ–¹æ³• å‚æ•°ï¼šåŸå§‹ä»£ç å­—ç¬¦ä¸² input
function compiler(input) {
  let tokens = tokenizer(input);
  let ast    = parser(tokens);
  let newAst = transformer(ast);
  let output = codeGenerator(newAst);
  return output;
}
```

## 3.3 è§£æé˜¶æ®µ
åœ¨è§£æé˜¶æ®µä¸­ï¼Œæˆ‘ä»¬å®šä¹‰**è¯æ³•åˆ†æå™¨æ–¹æ³•** `tokenizer`Â  å’Œ**è¯­æ³•åˆ†æå™¨æ–¹æ³•** `parser` ç„¶ååˆ†åˆ«å®ç°ï¼š<br />

```javascript
// è¯æ³•åˆ†æå™¨ å‚æ•°ï¼šåŸå§‹ä»£ç å­—ç¬¦ä¸² input
function tokenizer(input) {};

// è¯­æ³•åˆ†æå™¨ å‚æ•°ï¼šè¯æ³•å•å…ƒæ•°ç»„tokens
function parser(tokens) {};
```

### è¯æ³•åˆ†æå™¨
**è¯æ³•åˆ†æå™¨æ–¹æ³•** `tokenizer` çš„ä¸»è¦ä»»åŠ¡ï¼šéå†æ•´ä¸ªåŸå§‹ä»£ç å­—ç¬¦ä¸²ï¼Œå°†åŸå§‹ä»£ç å­—ç¬¦ä¸²è½¬æ¢ä¸º**è¯æ³•å•å…ƒæ•°ç»„ï¼ˆtokensï¼‰**ï¼Œå¹¶è¿”å›ã€‚<br />åœ¨éå†è¿‡ç¨‹ä¸­ï¼ŒåŒ¹é…æ¯ç§å­—ç¬¦å¹¶å¤„ç†æˆ**è¯æ³•å•å…ƒ**å‹å…¥**è¯æ³•å•å…ƒæ•°ç»„**ï¼Œå¦‚å½“åŒ¹é…åˆ°å·¦æ‹¬å·ï¼ˆ `(` ï¼‰æ—¶ï¼Œå°†å¾€**è¯æ³•å•å…ƒæ•°ç»„ï¼ˆtokensï¼‰**å‹å…¥ä¸€ä¸ª**è¯æ³•å•å…ƒå¯¹è±¡**ï¼ˆ`{type: 'paren', value:'('}`ï¼‰ã€‚<br />![è¯æ³•åˆ†æå™¨å·¥ä½œæµç¨‹.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585456159778-f7076314-d67f-46a5-b064-1a0ee70d7393.png#align=left&display=inline&height=3103&name=%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png&originHeight=3103&originWidth=3088&size=490525&status=done&style=none&width=3088)<br />

```javascript
// è¯æ³•åˆ†æå™¨ å‚æ•°ï¼šåŸå§‹ä»£ç å­—ç¬¦ä¸² input
function tokenizer(input) {
  let current = 0;  // å½“å‰è§£æçš„å­—ç¬¦ç´¢å¼•ï¼Œä½œä¸ºæ¸¸æ ‡
  let tokens = [];  // åˆå§‹åŒ–è¯æ³•å•å…ƒæ•°ç»„
  // å¾ªç¯éå†åŸå§‹ä»£ç å­—ç¬¦ä¸²ï¼Œè¯»å–è¯æ³•å•å…ƒæ•°ç»„
  while (current < input.length) {
    let char = input[current];
    // åŒ¹é…å·¦æ‹¬å·ï¼ŒåŒ¹é…æˆåŠŸåˆ™å‹å…¥å¯¹è±¡ {type: 'paren', value:'('}
    if (char === '(') {
      tokens.push({
        type: 'paren',
        value: '('
      });
      current++;
      continue; // è‡ªå¢currentï¼Œå®Œæˆæœ¬æ¬¡å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯
    }
    // åŒ¹é…å³æ‹¬å·ï¼ŒåŒ¹é…æˆåŠŸåˆ™å‹å…¥å¯¹è±¡ {type: 'paren', value:')'}
    if (char === ')') {
      tokens.push({
        type: 'paren',
        value: ')'
      });
      current++;
      continue;
    }
    
    // åŒ¹é…ç©ºç™½å­—ç¬¦ï¼ŒåŒ¹é…æˆåŠŸåˆ™è·³è¿‡
    // ä½¿ç”¨ \s åŒ¹é…ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦ã€æ¢è¡Œç¬¦ã€å‚ç›´åˆ¶è¡¨ç¬¦ç­‰
    let WHITESPACE = /\s/;
    if (WHITESPACE.test(char)) {
      current++;
      continue;
    }
    // åŒ¹é…æ•°å­—å­—ç¬¦ï¼Œä½¿ç”¨ [0-9]ï¼šåŒ¹é…
    // åŒ¹é…æˆåŠŸåˆ™å‹å…¥{type: 'number', value: value}
    // å¦‚ (add 123 456) ä¸­ 123 å’Œ 456 ä¸ºä¸¤ä¸ªæ•°å€¼è¯æ³•å•å…ƒ
    let NUMBERS = /[0-9]/;
    if (NUMBERS.test(char)) {
      let value = '';
      // åŒ¹é…è¿ç»­æ•°å­—ï¼Œä½œä¸ºæ•°å€¼
      while (NUMBERS.test(char)) {
        value += char;
        char = input[++current];
      }
      tokens.push({ type: 'number', value });
      continue;
    }
    // åŒ¹é…å½¢åŒå¼•å·åŒ…å›´çš„å­—ç¬¦ä¸²
    // åŒ¹é…æˆåŠŸåˆ™å‹å…¥ { type: 'string', value: value }
    // å¦‚ (concat "foo" "bar") ä¸­ "foo" å’Œ "bar" ä¸ºä¸¤ä¸ªå­—ç¬¦ä¸²è¯æ³•å•å…ƒ
    if (char === '"') {
      let value = '';
      char = input[++current]; // è·³è¿‡å·¦åŒå¼•å·
      // è·å–ä¸¤ä¸ªåŒå¼•å·ä¹‹é—´æ‰€æœ‰å­—ç¬¦
      while (char !== '"') {
        value += char;
        char = input[++current];
      }
      char = input[++current];// è·³è¿‡å³åŒå¼•å·
      tokens.push({ type: 'string', value });
      continue;
    }
    // åŒ¹é…å‡½æ•°åï¼Œè¦æ±‚åªå«å¤§å°å†™å­—æ¯ï¼Œä½¿ç”¨ [a-z] åŒ¹é… i æ¨¡å¼
    // åŒ¹é…æˆåŠŸåˆ™å‹å…¥ { type: 'name', value: value }
    // å¦‚ (add 2 4) ä¸­ add ä¸ºä¸€ä¸ªåç§°è¯æ³•å•å…ƒ
    let LETTERS = /[a-z]/i;
    if (LETTERS.test(char)) {
      let value = '';
      // è·å–è¿ç»­å­—ç¬¦
      while (LETTERS.test(char)) {
        value += char;
        char = input[++current];
      }
      tokens.push({ type: 'name', value });
      continue;
    }
    // å½“é‡åˆ°æ— æ³•è¯†åˆ«çš„å­—ç¬¦ï¼ŒæŠ›å‡ºé”™è¯¯æç¤ºï¼Œå¹¶é€€å‡º
    throw new TypeError('I dont know what this character is: ' + char);
  }
  // è¯æ³•åˆ†æå™¨çš„æœ€åè¿”å›è¯æ³•å•å…ƒæ•°ç»„
  return tokens;
}
```

### è¯­æ³•åˆ†æå™¨
**è¯­æ³•åˆ†æå™¨æ–¹æ³•** `parser` çš„ä¸»è¦ä»»åŠ¡ï¼šå°†**è¯æ³•åˆ†æå™¨**è¿”å›çš„**è¯æ³•å•å…ƒæ•°ç»„**ï¼Œè½¬æ¢ä¸ºèƒ½å¤Ÿæè¿°è¯­æ³•æˆåˆ†åŠå…¶å…³ç³»çš„ä¸­é—´å½¢å¼ï¼ˆ**æŠ½è±¡è¯­æ³•æ ‘ AST**ï¼‰ã€‚<br />![è¯­æ³•åˆ†æå™¨å·¥ä½œæµç¨‹.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585456363884-117559bc-969e-42a6-8b8d-cab549d307e7.png#align=left&display=inline&height=3088&name=%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png&originHeight=3088&originWidth=3080&size=484989&status=done&style=none&width=3080)<br />

```javascript
// è¯­æ³•åˆ†æå™¨ å‚æ•°ï¼šè¯æ³•å•å…ƒæ•°ç»„tokens
function parser(tokens) {
  let current = 0; // è®¾ç½®å½“å‰è§£æçš„è¯æ³•å•å…ƒçš„ç´¢å¼•ï¼Œä½œä¸ºæ¸¸æ ‡
  // é€’å½’éå†ï¼ˆå› ä¸ºå‡½æ•°è°ƒç”¨å…è®¸åµŒå¥—ï¼‰ï¼Œå°†è¯æ³•å•å…ƒè½¬æˆ LISP çš„ AST èŠ‚ç‚¹
  function walk() {
    // è·å–å½“å‰ç´¢å¼•ä¸‹çš„è¯æ³•å•å…ƒ token
    let token = tokens[current]; 

    // æ•°å€¼ç±»å‹è¯æ³•å•å…ƒ
    if (token.type === 'number') {
      current++; // è‡ªå¢å½“å‰ current å€¼
      // ç”Ÿæˆä¸€ä¸ª ASTèŠ‚ç‚¹ 'NumberLiteral'ï¼Œè¡¨ç¤ºæ•°å€¼å­—é¢é‡
      return {
        type: 'NumberLiteral',
        value: token.value,
      };
    }

    // å­—ç¬¦ä¸²ç±»å‹è¯æ³•å•å…ƒ
    if (token.type === 'string') {
      current++;
      // ç”Ÿæˆä¸€ä¸ª ASTèŠ‚ç‚¹ 'StringLiteral'ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²å­—é¢é‡
      return {
        type: 'StringLiteral',
        value: token.value,
      };
    }

    // å‡½æ•°ç±»å‹è¯æ³•å•å…ƒ
    if (token.type === 'paren' && token.value === '(') {
      // è·³è¿‡å·¦æ‹¬å·ï¼Œè·å–ä¸‹ä¸€ä¸ªè¯æ³•å•å…ƒä½œä¸ºå‡½æ•°å
      token = tokens[++current];

      let node = {
        type: 'CallExpression',
        name: token.value,
        params: []
      };

      // å†æ¬¡è‡ªå¢ current å˜é‡ï¼Œè·å–å‚æ•°è¯æ³•å•å…ƒ
      token = tokens[++current];

      // éå†æ¯ä¸ªè¯æ³•å•å…ƒï¼Œè·å–å‡½æ•°å‚æ•°ï¼Œç›´åˆ°å‡ºç°å³æ‹¬å·"ï¼‰"
      while ((token.type !== 'paren') || (token.type === 'paren' && token.value !== ')')) {
        node.params.push(walk());
        token = tokens[current];
      }

      current++; // è·³è¿‡å³æ‹¬å·
      return node;
    }
    // æ— æ³•è¯†åˆ«çš„å­—ç¬¦ï¼ŒæŠ›å‡ºé”™è¯¯æç¤º
    throw new TypeError(token.type);
  }

  // åˆå§‹åŒ– AST æ ¹èŠ‚ç‚¹
  let ast = {
    type: 'Program',
    body: [],
  };

  // å¾ªç¯å¡«å…… ast.body
  while (current < tokens.length) {
    ast.body.push(walk());
  }

  // æœ€åè¿”å›ast
  return ast;
}
```


## 3.4 è½¬æ¢é˜¶æ®µ
åœ¨è½¬æ¢é˜¶æ®µä¸­ï¼Œå®šä¹‰äº†è½¬æ¢å™¨ `transformer` å‡½æ•°ï¼Œä½¿ç”¨è¯æ³•åˆ†æå™¨è¿”å›çš„ LISP çš„ AST å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå°† AST å¯¹è±¡è½¬æ¢æˆä¸€ä¸ªæ–°çš„ AST å¯¹è±¡ã€‚<br />
<br />ä¸ºäº†æ–¹ä¾¿ä»£ç ç»„ç»‡ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªéå†å™¨ `traverser` æ–¹æ³•ï¼Œç”¨æ¥å¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œã€‚<br />

```javascript
// éå†å™¨ å‚æ•°ï¼šast å’Œ visitor
function traverser(ast, visitor) {
  // å®šä¹‰æ–¹æ³• traverseArray 
  // ç”¨äºéå† ASTèŠ‚ç‚¹æ•°ç»„ï¼Œå¯¹æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ è°ƒç”¨ traverseNode æ–¹æ³•ã€‚
  function traverseArray(array, parent) {
    array.forEach(child => {
      traverseNode(child, parent);
    });
  }

  // å®šä¹‰æ–¹æ³• traverseNode
  // ç”¨äºå¤„ç†æ¯ä¸ª AST èŠ‚ç‚¹ï¼Œæ¥å—ä¸€ä¸ª node å’Œå®ƒçš„çˆ¶èŠ‚ç‚¹ parent ä½œä¸ºå‚æ•°
  function traverseNode(node, parent) {
    // è·å– visitor ä¸Šå¯¹åº”æ–¹æ³•çš„å¯¹è±¡
    let methods = visitor[node.type];
    // è·å– visitor çš„ enter æ–¹æ³•ï¼Œå¤„ç†æ“ä½œå½“å‰ node
    if (methods && methods.enter) {
      methods.enter(node, parent);
    }

    switch (node.type) {
      // æ ¹èŠ‚ç‚¹
      case 'Program':
        traverseArray(node.body, node);
        break;
      // å‡½æ•°è°ƒç”¨
      case 'CallExpression':
        traverseArray(node.params, node);
        break;
      // æ•°å€¼å’Œå­—ç¬¦ä¸²ï¼Œå¿½ç•¥
      case 'NumberLiteral':
      case 'StringLiteral':
        break;

      // å½“é‡åˆ°æ— æ³•è¯†åˆ«çš„å­—ç¬¦ï¼ŒæŠ›å‡ºé”™è¯¯æç¤ºï¼Œå¹¶é€€å‡º
      default:
        throw new TypeError(node.type);
    }
    if (methods && methods.exit) {
      methods.exit(node, parent);
    }
  }
  // é¦–æ¬¡æ‰§è¡Œï¼Œå¼€å§‹éå†
  traverseNode(ast, null);
}
```

åœ¨çœ‹**éå†å™¨** `traverser` æ–¹æ³•æ—¶ï¼Œå»ºè®®ç»“åˆä¸‹é¢ä»‹ç»çš„**è½¬æ¢å™¨** `transformer` æ–¹æ³•é˜…è¯»ï¼š<br />

```javascript
// è½¬åŒ–å™¨ï¼Œå‚æ•°ï¼šast
function transformer(ast) {
  // åˆ›å»º newASTï¼Œä¸ä¹‹å‰ AST ç±»ä¼¼ï¼ŒProgramï¼šä½œä¸ºæ–° AST çš„æ ¹èŠ‚ç‚¹
  let newAst = {
    type: 'Program',
    body: [],
  };

  // é€šè¿‡ _context ç»´æŠ¤æ–°æ—§ ASTï¼Œæ³¨æ„ _context æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œä»æ—§çš„ AST åˆ°æ–°çš„ ASTã€‚
  ast._context = newAst.body;

  // é€šè¿‡éå†å™¨éå† å¤„ç†æ—§çš„ AST
  traverser(ast, {
    // æ•°å€¼ï¼Œç›´æ¥åŸæ ·æ’å…¥æ–°ASTï¼Œç±»å‹åç§° NumberLiteral
    NumberLiteral: {
      enter(node, parent) {
        parent._context.push({
          type: 'NumberLiteral',
          value: node.value,
        });
      },
    },
    // å­—ç¬¦ä¸²ï¼Œç›´æ¥åŸæ ·æ’å…¥æ–°ASTï¼Œç±»å‹åç§° StringLiteral
    StringLiteral: {
      enter(node, parent) {
        parent._context.push({
          type: 'StringLiteral',
          value: node.value,
        });
      },
    },
    // å‡½æ•°è°ƒç”¨
    CallExpression: {
      enter(node, parent) {
        // åˆ›å»ºä¸åŒçš„ASTèŠ‚ç‚¹
        let expression = {
          type: 'CallExpression',
          callee: {
            type: 'Identifier',
            name: node.name,
          },
          arguments: [],
        };

        // å‡½æ•°è°ƒç”¨æœ‰å­ç±»ï¼Œå»ºç«‹èŠ‚ç‚¹å¯¹åº”å…³ç³»ï¼Œä¾›å­èŠ‚ç‚¹ä½¿ç”¨
        node._context = expression.arguments;

        // é¡¶å±‚å‡½æ•°è°ƒç”¨ç®—æ˜¯è¯­å¥ï¼ŒåŒ…è£…æˆç‰¹æ®Šçš„ASTèŠ‚ç‚¹
        if (parent.type !== 'CallExpression') {

          expression = {
            type: 'ExpressionStatement',
            expression: expression,
          };
        }
        parent._context.push(expression);
      },
    }
  });
  return newAst;
}
```

é‡è¦ä¸€ç‚¹ï¼Œè¿™é‡Œé€šè¿‡ `_context` å¼•ç”¨æ¥**ç»´æŠ¤æ–°æ—§ AST å¯¹è±¡**ï¼Œç®¡ç†æ–¹ä¾¿ï¼Œé¿å…æ±¡æŸ“æ—§ AST å¯¹è±¡ã€‚<br />

## 3.5 ä»£ç ç”Ÿæˆ
æ¥ä¸‹æ¥åˆ°äº†æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰**ä»£ç ç”Ÿæˆå™¨** `codeGenerator` æ–¹æ³•ï¼Œé€šè¿‡é€’å½’ï¼Œå°†æ–°çš„ AST å¯¹è±¡ä»£ç è½¬æ¢æˆ JavaScript å¯æ‰§è¡Œä»£ç å­—ç¬¦ä¸²ã€‚<br />

```javascript
// ä»£ç ç”Ÿæˆå™¨ å‚æ•°ï¼šæ–° AST å¯¹è±¡
function codeGenerator(node) {

  switch (node.type) {
    // éå† body å±æ€§ä¸­çš„èŠ‚ç‚¹ï¼Œä¸”é€’å½’è°ƒç”¨ codeGeneratorï¼ŒæŒ‰è¡Œè¾“å‡ºç»“æœ
    case 'Program':
      return node.body.map(codeGenerator)
        .join('\n');

    // è¡¨è¾¾å¼ï¼Œå¤„ç†è¡¨è¾¾å¼å†…å®¹ï¼Œå¹¶ç”¨åˆ†å·ç»“å°¾
    case 'ExpressionStatement':
      return (
        codeGenerator(node.expression) +
        ';'
      );

    // å‡½æ•°è°ƒç”¨ï¼Œæ·»åŠ å·¦å³æ‹¬å·ï¼Œå‚æ•°ç”¨é€—å·éš”å¼€
    case 'CallExpression':
      return (
        codeGenerator(node.callee) +
        '(' +
        node.arguments.map(codeGenerator)
          .join(', ') +
        ')'
      );

    // æ ‡è¯†ç¬¦ï¼Œè¿”å›å…¶ name
    case 'Identifier':
      return node.name;
    // æ•°å€¼ï¼Œè¿”å›å…¶ value
    case 'NumberLiteral':
      return node.value;

    // å­—ç¬¦ä¸²ï¼Œç”¨åŒå¼•å·åŒ…è£¹å†è¾“å‡º
    case 'StringLiteral':
      return '"' + node.value + '"';

    // å½“é‡åˆ°æ— æ³•è¯†åˆ«çš„å­—ç¬¦ï¼ŒæŠ›å‡ºé”™è¯¯æç¤ºï¼Œå¹¶é€€å‡º
    default:
      throw new TypeError(node.type);
  }
}
```

## 3.6 ç¼–è¯‘å™¨æµ‹è¯•
æˆªæ­¢ä¸Šä¸€æ­¥ï¼Œæˆ‘ä»¬å®Œæˆç®€æ˜“ç¼–è¯‘å™¨çš„ä»£ç å¼€å‘ã€‚æ¥ä¸‹æ¥é€šè¿‡å‰é¢åŸå§‹éœ€æ±‚çš„ä»£ç ï¼Œæµ‹è¯•ç¼–è¯‘å™¨æ•ˆæœå¦‚ä½•ï¼š<br />

```javascript
const add = (a, b) => a + b;
const subtract = (a, b) => a - b;
const source = "(add 2 (subtract 4 2))";
const target = compiler(source); // "add(2, (subtract(4, 2));"

const result = eval(target); // Ok result is 4
```

## 3.7 å·¥ä½œæµç¨‹å°ç»“
æ€»ç»“ [The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/) ç¼–è¯‘å™¨æ•´ä¸ªå·¥ä½œæµç¨‹ï¼š<br />**1ã€input => tokenizer => tokens**<br />**2ã€tokens => parser => ast**<br />**3ã€ast => transformer => newAst**<br />**4ã€newAst => generator => output**<br />

å…¶å®å¤šæ•°ç¼–è¯‘å™¨çš„å·¥ä½œæµç¨‹éƒ½å¤§è‡´ç›¸åŒï¼š
![The Super Tiny Compilerç¼–è¯‘å™¨å·¥ä½œæµç¨‹ï¼ˆæ–¹æ³•å®ç°ï¼‰.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585456041691-1bc463b9-57bf-4e94-85f2-96dfd3142376.png#align=left&display=inline&height=2073&name=The%20Super%20Tiny%20Compiler%E7%BC%96%E8%AF%91%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%88%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%EF%BC%89.png&originHeight=2073&originWidth=3104&size=276249&status=done&style=none&width=3104)


# å››ã€æ‰‹å†™ Webpack ç¼–è¯‘å™¨
æ ¹æ®ä¹‹å‰ä»‹ç»çš„ [The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/)ç¼–è¯‘å™¨æ ¸å¿ƒå·¥ä½œæµç¨‹ï¼Œå†æ¥æ‰‹å†™ Webpack çš„ç¼–è¯‘å™¨ï¼Œä¼šè®©ä½ æœ‰ç§ä¼—äº«ä¸æ»‘çš„æ„Ÿè§‰~<br />![](https://st-gdx.dancf.com/gaodingx/0/design/20191030-163349-cca6.gif)

<br />è¯è¯´ï¼Œæœ‰äº›é¢è¯•å®˜å–œæ¬¢é—®è¿™ä¸ªå‘¢ã€‚å½“ç„¶ï¼Œæ‰‹å†™ä¸€éèƒ½è®©æˆ‘ä»¬æ›´äº†è§£ Webpack çš„æ„å»ºæµç¨‹ï¼Œè¿™ä¸ªç« èŠ‚æˆ‘ä»¬ç®€è¦ä»‹ç»ä¸€ä¸‹ã€‚


## 4.1 Webpack æ„å»ºæµç¨‹åˆ†æ
ä»å¯åŠ¨æ„å»ºåˆ°è¾“å‡ºç»“æœä¸€ç³»åˆ—è¿‡ç¨‹ï¼š

1. **åˆå§‹åŒ–å‚æ•°**

è§£æ Webpack é…ç½®å‚æ•°ï¼Œåˆå¹¶ Shell ä¼ å…¥å’Œ `webpack.config.js` æ–‡ä»¶é…ç½®çš„å‚æ•°ï¼Œå½¢æˆæœ€åçš„é…ç½®ç»“æœã€‚<br />

2. **å¼€å§‹ç¼–è¯‘**

ä¸Šä¸€æ­¥å¾—åˆ°çš„å‚æ•°åˆå§‹åŒ– `compiler` å¯¹è±¡ï¼Œæ³¨å†Œæ‰€æœ‰é…ç½®çš„æ’ä»¶ï¼Œæ’ä»¶ç›‘å¬ Webpack æ„å»ºç”Ÿå‘½å‘¨æœŸçš„äº‹ä»¶èŠ‚ç‚¹ï¼Œåšå‡ºç›¸åº”çš„ååº”ï¼Œæ‰§è¡Œå¯¹è±¡çš„ `run` æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘ã€‚<br />

3. **ç¡®å®šå…¥å£**

ä»é…ç½®çš„ `entry` å…¥å£ï¼Œå¼€å§‹è§£ææ–‡ä»¶æ„å»º AST è¯­æ³•æ ‘ï¼Œæ‰¾å‡ºä¾èµ–ï¼Œé€’å½’ä¸‹å»ã€‚<br />

4. **ç¼–è¯‘æ¨¡å—**

é€’å½’ä¸­æ ¹æ®**æ–‡ä»¶ç±»å‹**å’Œ **loader é…ç½®**ï¼Œè°ƒç”¨æ‰€æœ‰é…ç½®çš„ loader å¯¹æ–‡ä»¶è¿›è¡Œè½¬æ¢ï¼Œå†æ‰¾å‡ºè¯¥æ¨¡å—ä¾èµ–çš„æ¨¡å—ï¼Œå†é€’å½’æœ¬æ­¥éª¤ç›´åˆ°æ‰€æœ‰å…¥å£ä¾èµ–çš„æ–‡ä»¶éƒ½ç»è¿‡äº†æœ¬æ­¥éª¤çš„å¤„ç†ã€‚<br />

5. **å®Œæˆæ¨¡å—ç¼–è¯‘å¹¶è¾“å‡º**

é€’å½’å®Œäº‹åï¼Œå¾—åˆ°æ¯ä¸ªæ–‡ä»¶ç»“æœï¼ŒåŒ…å«æ¯ä¸ªæ¨¡å—ä»¥åŠä»–ä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæ ¹æ® `entry` é…ç½®ç”Ÿæˆä»£ç å— `chunk` ã€‚<br />

6. **è¾“å‡ºå®Œæˆ**

è¾“å‡ºæ‰€æœ‰çš„ `chunk` åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚<br />
<br />æ³¨æ„ï¼šåœ¨æ„å»ºç”Ÿå‘½å‘¨æœŸä¸­æœ‰ä¸€ç³»åˆ—æ’ä»¶åœ¨åšåˆé€‚çš„æ—¶æœºåšåˆé€‚äº‹æƒ…ï¼Œæ¯”å¦‚ `UglifyPlugin` ä¼šåœ¨ loader è½¬æ¢é€’å½’å®Œå¯¹ç»“æœä½¿ç”¨ `UglifyJs` å‹ç¼©**è¦†ç›–ä¹‹å‰çš„ç»“æœ**ã€‚<br />![Webpack æ„å»ºæµç¨‹.png](https://cdn.nlark.com/yuque/0/2020/png/186051/1585454497440-d1a74a5f-189e-49f0-92c4-3bac8ce93c17.png#align=left&display=inline&height=2568&name=Webpack%20%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B.png&originHeight=2568&originWidth=2120&size=251613&status=done&style=none&width=2120)

## 4.2 ä»£ç å®ç°
æ‰‹å†™ Webpack éœ€è¦å®ç°ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š

- `createAssets` : æ”¶é›†å’Œå¤„ç†æ–‡ä»¶çš„ä»£ç ï¼›
- `createGraph` ï¼šæ ¹æ®å…¥å£æ–‡ä»¶ï¼Œè¿”å›æ‰€æœ‰æ–‡ä»¶ä¾èµ–å›¾ï¼›
- `bundle` : æ ¹æ®ä¾èµ–å›¾æ•´ä¸ªä»£ç å¹¶è¾“å‡ºï¼›


### 1. createAssets
```javascript
function createAssets(filename){
    const content = fs.readFileSync(filename, "utf-8"); // æ ¹æ®æ–‡ä»¶åè¯»å–æ–‡ä»¶å†…å®¹
  
  	// å°†è¯»å–åˆ°çš„ä»£ç å†…å®¹ï¼Œè½¬æ¢ä¸º AST
    const ast = parser.parse(content, {
        sourceType: "module" // æŒ‡å®šæºç ç±»å‹
    })
    const dependencies = []; // ç”¨äºæ”¶é›†æ–‡ä»¶ä¾èµ–çš„è·¯å¾„

  	// é€šè¿‡ traverse æä¾›çš„æ“ä½œ AST çš„æ–¹æ³•ï¼Œè·å–æ¯ä¸ªèŠ‚ç‚¹çš„ä¾èµ–è·¯å¾„
    traverse(ast, {
        ImportDeclaration: ({node}) => {
            dependencies.push(node.source.value);
        }
    });

  	// é€šè¿‡ AST å°† ES6 ä»£ç è½¬æ¢æˆ ES5 ä»£ç 
    const { code } = babel.transformFromAstSync(ast, null, {
        presets: ["@babel/preset-env"]
    });

    let id = moduleId++;
    return {
        id,
        filename,
        code,
        dependencies
    }
}
```

### 2. createGraph
```javascript
function createGraph(entry) {
    const mainAsset = createAssets(entry); // è·å–å…¥å£æ–‡ä»¶ä¸‹çš„å†…å®¹
    const queue = [mainAsset];
    for(const asset of queue){
        const dirname = path.dirname(asset.filename);
        asset.mapping = {};
        asset.dependencies.forEach(relativePath => {
            const absolutePath = path.join(dirname, relativePath); // è½¬æ¢æ–‡ä»¶è·¯å¾„ä¸ºç»å¯¹è·¯å¾„
            const child = createAssets(absolutePath);
            asset.mapping[relativePath] = child.id;
            queue.push(child); // é€’å½’å»éå†æ‰€æœ‰å­èŠ‚ç‚¹çš„æ–‡ä»¶
        })
    }
    return queue;
}
```

### 3. bunlde
```javascript
function bundle(graph) {
    let modules = "";
    graph.forEach(item => {
        modules += `
            ${item.id}: [
                function (require, module, exports){
                    ${item.code}
                },
                ${JSON.stringify(item.mapping)}
            ],
        `
    })
    return `
        (function(modules){
            function require(id){
                const [fn, mapping] = modules[id];
                function localRequire(relativePath){
                    return require(mapping[relativePath]);
                }

                const module = {
                    exports: {}
                }

                fn(localRequire, module, module.exports);

                return module.exports;
            }
            require(0);
        })({${modules}})
    `
}
```


# äº”ã€æ€»ç»“
æœ¬æ–‡ä»ç¼–è¯‘å™¨æ¦‚å¿µå’ŒåŸºæœ¬å·¥ä½œæµç¨‹å¼€å§‹ä»‹ç»ï¼Œç„¶åé€šè¿‡ [The Super Tiny Compiler](https://the-super-tiny-compiler.glitch.me/) è¯‘å™¨æºç ï¼Œè¯¦ç»†ä»‹ç»æ ¸å¿ƒå·¥ä½œæµç¨‹å®ç°ï¼ŒåŒ…æ‹¬**è¯æ³•åˆ†æå™¨**ã€**è¯­æ³•åˆ†æå™¨**ã€**éå†å™¨**å’Œ**è½¬æ¢å™¨**çš„åŸºæœ¬å®ç°ï¼Œæœ€åé€šè¿‡**ä»£ç ç”Ÿæˆå™¨**ï¼Œå°†å„ä¸ªé˜¶æ®µä»£ç ç»“åˆèµ·æ¥ï¼Œå®ç°äº†è¿™ä¸ªå·ç§°**å¯èƒ½æ˜¯æœ‰å²ä»¥æ¥æœ€å°çš„ç¼–è¯‘å™¨ã€‚**<br />æœ¬æ–‡ä¹Ÿç®€è¦ä»‹ç»äº†**æ‰‹å†™ Webpack çš„å®ç°**ï¼Œéœ€è¦è¯»è€…è‡ªè¡Œå®Œå–„å’Œæ·±å…¥å“Ÿï¼
æ˜¯ä¸æ˜¯è§‰å¾—å¾ˆç¥å¥‡~<br />
![](https://st0.dancf.com/csc/346/templets/20191106-155044-c33a.gif)<br />
å½“ç„¶é€šè¿‡æœ¬æ–‡å­¦ä¹ ï¼Œä¹Ÿä»…ä»…æ˜¯ç¼–è¯‘å™¨ç›¸å…³çŸ¥è¯†çš„è¾¹å±±ä¸€è„šï¼Œè¦å­¦çš„çŸ¥è¯†è¿˜æœ‰éå¸¸å¤šï¼Œä¸è¿‡å¥½çš„å¼€å¤´ï¼Œæ›´èƒ½ä¿ƒè¿›æˆ‘ä»¬å­¦ä¹ åŠ¨åŠ›ã€‚åŠ æ²¹ï¼<br />
<br />æœ€åï¼Œæ–‡ä¸­ä»‹ç»åˆ°çš„ä»£ç ï¼Œæˆ‘å­˜æ”¾åœ¨ Github ä¸Šï¼š

1. [[learning]the-super-tiny-compiler.js](https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Frontend/learningSourceCode/%5Blearning%5Dthe-super-tiny-compiler.js "[learning]the-super-tiny-compiler.js")
1. [[writing]webpack-compiler.js](https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Frontend/learningSourceCode/%5Bwriting%5Dwebpack-compiler.js "[writing]webpack-compiler.js")


# å…­ã€å‚è€ƒèµ„æ–™

1. [ã€ŠThe Super Tiny Compilerã€‹](https://the-super-tiny-compiler.glitch.me/ "ã€ŠThe Super Tiny Compilerã€‹")
1. [ã€Šæœ‰å²ä»¥æ¥æœ€å°çš„ç¼–è¯‘å™¨æºç è§£æã€‹](https://segmentfault.com/a/1190000016402699 "ã€Šæœ‰å²ä»¥æ¥æœ€å°çš„ç¼–è¯‘å™¨æºç è§£æã€‹")
1. [ã€ŠAngular 2 JIT vs AOTã€‹](https://segmentfault.com/a/1190000008739157 "ã€ŠAngular 2 JIT vs AOTã€‹")

# å…³äºæˆ‘

|Author|ç‹å¹³å®‰|
|---|---|
|E-mail|pingan8787@qq.com|
|åš  å®¢|www.pingan8787.com|
|å¾®  ä¿¡|pingan8787|
|æ¯æ—¥æ–‡ç« æ¨è|https://github.com/pingan8787/Leo_Reading/issues|
|ESå°å†Œ|js.pingan8787.com|

![](https://user-gold-cdn.xitu.io/2020/2/22/1706bb1ea5f680ae?w=885&h=445&f=png&s=80093)  